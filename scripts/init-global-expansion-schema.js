import PocketBase from 'pocketbase';

const pb = new PocketBase(process.env.POCKETBASE_URL || 'http://localhost:8090');

async function createCollection(name, schema, extraOptions = {}) {
    try {
        console.log(`Creating collection: ${name}...`);
        await pb.collections.create({
            name,
            type: 'base',
            schema,
            ...extraOptions
        });
        console.log(`‚úÖ Collection ${name} created successfully`);
    } catch (error) {
        if (error.message && error.message.includes('already exists')) {
            console.log(`‚ö†Ô∏è Collection ${name} already exists, skipping...`);
        } else {
            console.error(`‚ùå Error creating collection ${name}:`, error);
        }
    }
}

async function main() {
    try {
        console.log('Authenticating...');
        const adminEmail = process.env.POCKETBASE_ADMIN_EMAIL || process.env.PB_ADMIN_EMAIL || 'owner@growyourneed.com';
        const adminPass = process.env.POCKETBASE_ADMIN_PASSWORD || process.env.PB_ADMIN_PASS || 'Darnag12345678@';
        
        await pb.collection('_superusers').authWithPassword(adminEmail, adminPass);
        console.log('‚úÖ Authenticated successfully');

        console.log('\n=== Creating Global Expansion Collections ===\n');

        // Translations Collection
        await createCollection('translations', [
            {
                name: 'key',
                type: 'text',
                required: true
            },
            {
                name: 'language',
                type: 'text',
                required: true
            },
            {
                name: 'value',
                type: 'text',
                required: true
            },
            {
                name: 'context',
                type: 'text',
                required: false
            },
            {
                name: 'category',
                type: 'select',
                required: true,
                options: {
                    maxSelect: 1,
                    values: ['ui', 'content', 'error', 'notification', 'email']
                }
            },
            {
                name: 'autoGenerated',
                type: 'bool',
                required: true
            },
            {
                name: 'verified',
                type: 'bool',
                required: true
            },
            {
                name: 'translatorId',
                type: 'relation',
                required: false,
                options: {
                    collectionId: '_pb_users_auth_',
                    cascadeDelete: false
                }
            },
            {
                name: 'metadata',
                type: 'json',
                required: false
            }
        ]);

        // Currencies Collection
        await createCollection('currencies', [
            {
                name: 'code',
                type: 'text',
                required: true
            },
            {
                name: 'name',
                type: 'text',
                required: true
            },
            {
                name: 'symbol',
                type: 'text',
                required: true
            },
            {
                name: 'exchangeRate',
                type: 'number',
                required: true
            },
            {
                name: 'baseCurrency',
                type: 'text',
                required: true
            },
            {
                name: 'decimalPlaces',
                type: 'number',
                required: true
            },
            {
                name: 'active',
                type: 'bool',
                required: true
            },
            {
                name: 'lastUpdated',
                type: 'date',
                required: true
            }
        ], {
            // Public read access for currency data
            listRule: '',
            viewRule: ''
        });

        // Compliance Logs Collection
        await createCollection('compliance_logs', [
            {
                name: 'tenantId',
                type: 'text',
                required: true
            },
            {
                name: 'regulation',
                type: 'select',
                required: true,
                options: {
                    maxSelect: 1,
                    values: ['GDPR', 'PIPL', 'LGPD', 'IT_ACT', 'COPPA', 'HIPAA', 'SOC2', 'ISO27001']
                }
            },
            {
                name: 'action',
                type: 'text',
                required: true
            },
            {
                name: 'userId',
                type: 'relation',
                required: false,
                options: {
                    collectionId: '_pb_users_auth_',
                    cascadeDelete: false
                }
            },
            {
                name: 'ipAddress',
                type: 'text',
                required: true
            },
            {
                name: 'userAgent',
                type: 'text',
                required: false
            },
            {
                name: 'data',
                type: 'json',
                required: false
            },
            {
                name: 'severity',
                type: 'select',
                required: true,
                options: {
                    maxSelect: 1,
                    values: ['info', 'warning', 'critical']
                }
            },
            {
                name: 'status',
                type: 'select',
                required: true,
                options: {
                    maxSelect: 1,
                    values: ['logged', 'reviewed', 'resolved']
                }
            }
        ], {
            // Only admins can access compliance logs
            listRule: '@request.auth.id != "" && @request.auth.role = "Owner"',
            viewRule: '@request.auth.id != "" && @request.auth.role = "Owner"',
            createRule: '@request.auth.id != ""',
            updateRule: '@request.auth.id != "" && @request.auth.role = "Owner"'
        });

        // Regional Settings Collection
        await createCollection('regional_settings', [
            {
                name: 'tenantId',
                type: 'text',
                required: true
            },
            {
                name: 'region',
                type: 'text',
                required: true
            },
            {
                name: 'country',
                type: 'text',
                required: true
            },
            {
                name: 'timezone',
                type: 'text',
                required: true
            },
            {
                name: 'currency',
                type: 'text',
                required: true
            },
            {
                name: 'language',
                type: 'text',
                required: true
            },
            {
                name: 'secondaryLanguages',
                type: 'json',
                required: false
            },
            {
                name: 'dateFormat',
                type: 'text',
                required: true
            },
            {
                name: 'timeFormat',
                type: 'text',
                required: true
            },
            {
                name: 'compliance',
                type: 'json',
                required: true
            },
            {
                name: 'taxConfig',
                type: 'json',
                required: false
            },
            {
                name: 'dataResidency',
                type: 'text',
                required: false
            },
            {
                name: 'active',
                type: 'bool',
                required: true
            }
        ], {
            // Tenant-scoped access
            listRule: '@request.auth.id != "" && tenantId = @request.auth.tenantId',
            viewRule: '@request.auth.id != "" && tenantId = @request.auth.tenantId'
        });

        // Language Settings Collection
        await createCollection('language_settings', [
            {
                name: 'tenantId',
                type: 'text',
                required: false
            },
            {
                name: 'code',
                type: 'text',
                required: true
            },
            {
                name: 'name',
                type: 'text',
                required: true
            },
            {
                name: 'nativeName',
                type: 'text',
                required: true
            },
            {
                name: 'direction',
                type: 'select',
                required: true,
                options: {
                    maxSelect: 1,
                    values: ['ltr', 'rtl']
                }
            },
            {
                name: 'flag',
                type: 'text',
                required: false
            },
            {
                name: 'enabled',
                type: 'bool',
                required: true
            },
            {
                name: 'isDefault',
                type: 'bool',
                required: true
            },
            {
                name: 'completionPercentage',
                type: 'number',
                required: true
            },
            {
                name: 'translatorId',
                type: 'relation',
                required: false,
                options: {
                    collectionId: '_pb_users_auth_',
                    cascadeDelete: false
                }
            }
        ]);

        // Translation Cache Collection
        await createCollection('translation_cache', [
            {
                name: 'key',
                type: 'text',
                required: true
            },
            {
                name: 'sourceLang',
                type: 'text',
                required: true
            },
            {
                name: 'targetLang',
                type: 'text',
                required: true
            },
            {
                name: 'sourceText',
                type: 'text',
                required: true
            },
            {
                name: 'translatedText',
                type: 'text',
                required: true
            },
            {
                name: 'provider',
                type: 'select',
                required: true,
                options: {
                    maxSelect: 1,
                    values: ['deepl', 'google', 'manual']
                }
            },
            {
                name: 'quality',
                type: 'number',
                required: false
            },
            {
                name: 'hits',
                type: 'number',
                required: true
            },
            {
                name: 'lastUsed',
                type: 'date',
                required: true
            }
        ], {
            // Public read for translation cache
            listRule: '',
            viewRule: ''
        });

        console.log('\n‚úÖ Global Expansion schema initialization complete!');
        console.log('\nüìä Created Collections:');
        console.log('  - translations');
        console.log('  - currencies');
        console.log('  - compliance_logs');
        console.log('  - regional_settings');
        console.log('  - language_settings');
        console.log('  - translation_cache');
        console.log('\n‚ú® Next steps:');
        console.log('  1. Run: node scripts/seed-global-expansion-data.js');
        console.log('  2. Create Global Expansion service: src/services/globalExpansionService.ts');
        console.log('  3. Integrate translation APIs (DeepL, Google Translate)');
        console.log('  4. Integrate currency API (Exchange Rates API)');
    } catch (error) {
        console.error('‚ùå Schema initialization failed:', error);
        process.exit(1);
    }
}

main();
